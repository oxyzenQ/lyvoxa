# =============================================================================
# LYVOXA CI/CD PIPELINE - GITHUB ACTIONS
# =============================================================================
# Automated build, test, and release pipeline optimized for ArchLinux
# Author: rezky_nightky
# Version: Stellar 2.0

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, titanium]
    tags: ["Stellar-*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Use GitHub Actions default cores (no custom limits)
  # Cache configuration (optional, fallback if sccache fails)
  SCCACHE_GHA_ENABLED: false

jobs:
  # =============================================================================
  # CODE QUALITY CHECKS
  # =============================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup sccache (optional)
        uses: mozilla-actions/sccache-action@v0.0.3
        continue-on-error: true
        with:
          version: "v0.5.4"

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Update dependencies
        run: |
          echo "ðŸ“¦ Updating dependencies..."
          cargo update
          echo "âœ… Dependencies updated"

      - name: Run code formatting check
        run: cargo fmt --check

      - name: Run Clippy
        run: |
          unset RUSTC_WRAPPER
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Audit dependencies (ignore unmaintained)
        run: |
          # Run audit but only fail on actual vulnerabilities, not maintenance warnings
          cargo audit --ignore RUSTSEC-2024-0436 || echo "Audit completed with warnings (non-critical)"

  # =============================================================================
  # BUILD AND TEST - LINUX X86_64
  # =============================================================================
  build-linux:
    name: Build and Test (Linux x86_64)
    runs-on: ubuntu-latest
    needs: quality
    strategy:
      matrix:
        profile: [debug]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Setup sccache (optional)
        uses: mozilla-actions/sccache-action@v0.0.3
        continue-on-error: true
        with:
          version: "v0.5.4"

      - name: Cache Cargo target
        uses: actions/cache@v4
        with:
          path: target/
          key: ${{ runner.os }}-cargo-target-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ matrix.profile }}-
            ${{ runner.os }}-cargo-target-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build (Debug)
        if: matrix.profile == 'debug'
        run: |
          echo "Building debug version with GitHub Actions default cores..."
          unset RUSTC_WRAPPER  # Disable sccache if causing issues
          cargo build --target x86_64-unknown-linux-gnu

      - name: Build (Release)
        if: matrix.profile == 'release'
        run: |
          echo "Building release version with GitHub Actions default cores..."
          unset RUSTC_WRAPPER  # Disable sccache if causing issues
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Run tests
        run: |
          echo "Running tests with GitHub Actions default cores..."
          unset RUSTC_WRAPPER  # Disable sccache if causing issues
          cargo test --target x86_64-unknown-linux-gnu

      - name: Run benchmarks
        if: matrix.profile == 'release'
        run: |
          unset RUSTC_WRAPPER  # Disable sccache if causing issues
          cargo bench --target x86_64-unknown-linux-gnu

      - name: Check binary size
        if: matrix.profile == 'release'
        run: |
          ls -la target/x86_64-unknown-linux-gnu/release/
          echo "Main binary size:"
          du -h target/x86_64-unknown-linux-gnu/release/lyvoxa
          echo "Simple binary size:"
          du -h target/x86_64-unknown-linux-gnu/release/lyvoxa-simple

      - name: Upload artifacts (Release)
        if: matrix.profile == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: lyvoxa-linux-x86_64
          path: |
            target/x86_64-unknown-linux-gnu/release/lyvoxa
            target/x86_64-unknown-linux-gnu/release/lyvoxa-simple
          retention-days: 30

      - name: Show sccache stats
        run: sccache --show-stats

  # =============================================================================
  # FUTURE: MACOS BUILD (COMMENTED OUT)
  # =============================================================================
  # build-macos:
  #   name: Build and Test (macOS)
  #   runs-on: macos-latest
  #   needs: quality
  #   if: false  # Disabled for now
  #   strategy:
  #     matrix:
  #       target: [x86_64-apple-darwin, aarch64-apple-darwin]
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         targets: ${{ matrix.target }}
  #
  #     - name: Build
  #       run: |
  #         cargo build --release --target ${{ matrix.target }}
  #
  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: lyvoxa-${{ matrix.target }}
  #         path: target/${{ matrix.target }}/release/lyvoxa*

  # =============================================================================
  # CI BUILD COMPLETE - RELEASES HANDLED BY release.yml ON TAG PUSH
  # =============================================================================

  # =============================================================================
  # PERFORMANCE MONITORING (DEBUG BUILDS)
  # =============================================================================
  performance:
    name: Performance Monitoring (Debug)
    runs-on: ubuntu-latest
    needs: build-linux
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Download debug artifacts
        uses: actions/download-artifact@v4
        with:
          name: lyvoxa-linux-x86_64
          path: ./artifacts/

      - name: Run debug build validation
        run: |
          chmod +x artifacts/lyvoxa artifacts/lyvoxa-simple

          echo "ðŸ“Š Debug Build Analysis:"
          echo "========================="
          ls -la artifacts/
          echo ""
          echo "File sizes (debug):"
          du -h artifacts/*
          echo ""

          echo "ðŸ“ˆ Binary Information:"
          echo "====================="
          file artifacts/lyvoxa
          file artifacts/lyvoxa-simple
          echo ""

          echo "ðŸ” Binary Dependencies:"
          echo "======================"
          ldd artifacts/lyvoxa || echo "Static binary (no dynamic dependencies)"
          echo ""

          echo "ðŸ§ª Debug Build Validation:"
          echo "=========================="
          echo "Main binary: $(du -h artifacts/lyvoxa | cut -f1)"
          echo "Simple binary: $(du -h artifacts/lyvoxa-simple | cut -f1)"

          # Calculate compression ratio
          MAIN_SIZE=$(stat -c%s artifacts/lyvoxa)
          SIMPLE_SIZE=$(stat -c%s artifacts/lyvoxa-simple)
          TOTAL_SIZE=$((MAIN_SIZE + SIMPLE_SIZE))
          echo "Total size: $(numfmt --to=iec $TOTAL_SIZE)"

          # Basic validation (check if binaries are valid ELF)
          echo ""
          echo "ðŸ§ª Binary Validation:"
          echo "===================="
          if readelf -h artifacts/lyvoxa > /dev/null 2>&1; then
            echo "âœ… lyvoxa: Valid ELF binary"
          else
            echo "âŒ lyvoxa: Invalid binary"
            exit 1
          fi

          if readelf -h artifacts/lyvoxa-simple > /dev/null 2>&1; then
            echo "âœ… lyvoxa-simple: Valid ELF binary"
          else
            echo "âŒ lyvoxa-simple: Invalid binary"
            exit 1
          fi

          echo ""
          echo "ðŸŽ¯ Performance Summary:"
          echo "======================"
          echo "âœ… Binaries built successfully"
          echo "âœ… Size optimization: Simple binary is $(echo "scale=1; $SIMPLE_SIZE * 100 / $MAIN_SIZE" | bc)% of main binary size"
          echo "âœ… Ready for distribution"

      - name: Comment PR with performance
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            try {
              const binarySize = execSync('du -h artifacts/lyvoxa | cut -f1').toString().trim();
              const simpleBinarySize = execSync('du -h artifacts/lyvoxa-simple | cut -f1').toString().trim();
              const totalSize = execSync('du -ch artifacts/* | tail -1 | cut -f1').toString().trim();

              // Get binary info
              const binaryInfo = execSync('file artifacts/lyvoxa').toString().trim();
              const isStripped = binaryInfo.includes('stripped') ? 'âœ… Stripped' : 'âš ï¸ Not stripped';

              const comment = `## ðŸ§ª Debug Build Analysis Report

              ### ðŸ“¦ Debug Binary Sizes
              | Binary | Size | Description |
              |--------|------|-------------|
              | **lyvoxa** | **${binarySize}** | Main TUI application (debug) |
              | **lyvoxa-simple** | **${simpleBinarySize}** | Lightweight version (debug) |
              | **Total** | **${totalSize}** | Combined debug package size |

              ### ðŸ” Binary Details
              - **Architecture**: Linux x86_64
              - **Build Profile**: Debug (unoptimized, with debug info)
              - **Symbols**: ${isStripped}
              - **Dependencies**: Statically linked

              ### ðŸ§ª Debug Build Notes
              - Debug build for development and testing
              - Contains debug symbols and no optimizations
              - Larger size than release builds
              - Used for validation and development

              > ðŸŽ¯ **Quality Check**: All debug binaries validated as proper ELF executables
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Error creating performance comment:', error);
            }

# =============================================================================
# WORKFLOW CONFIGURATION
# =============================================================================

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
