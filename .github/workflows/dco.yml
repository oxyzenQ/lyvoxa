name: DCO Check

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Security: Explicit permissions (principle of least privilege)
permissions:
  contents: read
  pull-requests: read

jobs:
  dco:
    runs-on: ubuntu-latest
    # Skip DCO check for Dependabot PRs (they auto-generate commits)
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine commit range
        id: range
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.base_ref }}"
            RANGE="origin/${base}..HEAD"
          else
            RANGE="HEAD~10..HEAD"
          fi
          echo "range=$RANGE" >> "$GITHUB_OUTPUT"
          echo "Commit range: $RANGE"

      - name: Check DCO sign-offs
        run: |
          set -euo pipefail
          RANGE="${{ steps.range.outputs.range }}"
          COMMITS=$(git rev-list --no-merges $RANGE)
          echo "Checking commits:"
          echo "$COMMITS" | sed 's/^/ - /'
          fail=0
          while read -r c; do
            msg=$(git show -s --format=%B "$c")
            if ! grep -qiE '^Signed-off-by: .+ <.+@.+>$' <<< "$msg"; then
              echo "Missing DCO sign-off in commit $c" >&2
              fail=1
            fi
          done <<< "$COMMITS"
          if [[ "$fail" -ne 0 ]]; then
            echo "DCO check failed. Please add Signed-off-by lines (git commit -s)." >&2
            exit 1
          fi
          echo "All commits include DCO sign-off."
