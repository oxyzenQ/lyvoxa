# =============================================================================
# AUR AUTO-RELEASE WORKFLOW
# =============================================================================
# Automatically sync PKGBUILD to AUR repository when updated
# Single source of truth: GitHub repo â†’ Auto mirror to AUR
# Zero manual maintenance required

name: ğŸ“¦ AUR Release

on:
  push:
    paths:
      - 'lyvoxa-bin/**'
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_push:
        description: 'Force push even if no changes detected'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  aur-sync:
    name: ğŸ”„ Sync to AUR Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup SSH for AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          echo "ğŸ” Setting up SSH for AUR..."
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            StrictHostKeyChecking accept-new
          EOF
          
          echo "âœ… SSH configured"

      - name: Install makepkg tools
        run: |
          echo "ğŸ“¦ Installing Arch packaging tools..."
          sudo apt-get update -qq
          sudo apt-get install -y pacman-package-manager
          
          echo "âœ… Tools installed"

      - name: Validate PKGBUILD
        run: |
          echo "ğŸ” Validating PKGBUILD syntax..."
          cd lyvoxa-bin
          
          # Check basic PKGBUILD syntax
          bash -n PKGBUILD || {
            echo "âŒ PKGBUILD has syntax errors!"
            exit 1
          }
          
          # Check required variables
          source PKGBUILD
          [[ -z "$pkgname" ]] && { echo "âŒ pkgname not set!"; exit 1; }
          [[ -z "$pkgver" ]] && { echo "âŒ pkgver not set!"; exit 1; }
          [[ -z "$pkgrel" ]] && { echo "âŒ pkgrel not set!"; exit 1; }
          
          echo "âœ… PKGBUILD validation passed"
          echo "ğŸ“‹ Package: $pkgname-$pkgver-$pkgrel"

      - name: Generate .SRCINFO
        run: |
          echo "ğŸ“ Generating .SRCINFO..."
          cd lyvoxa-bin
          
          # Install namcap for validation (optional but good practice)
          # makepkg --printsrcinfo > .SRCINFO
          
          # For now, use bash to extract info (since we don't have full makepkg)
          source PKGBUILD
          
          cat > .SRCINFO << EOF
          pkgbase = $pkgname
          	pkgdesc = $pkgdesc
          	pkgver = $pkgver
          	pkgrel = $pkgrel
          	url = $url
          	arch = ${arch[0]}
          	license = ${license[0]}
          	depends = ${depends[0]}
          	provides = ${provides[0]}
          	conflicts = ${conflicts[0]}
          	conflicts = ${conflicts[1]}
          	options = ${options[0]}
          	source = ${source[0]}
          	source = ${source[1]}
          	source = ${source[2]}
          	validpgpkeys = ${validpgpkeys[0]}
          	sha256sums = SKIP
          	sha256sums = SKIP
          	sha256sums = SKIP

          pkgname = $pkgname
          EOF
          
          echo "âœ… .SRCINFO generated"
          echo ""
          echo "Preview:"
          cat .SRCINFO

      - name: Clone AUR repository
        run: |
          echo "ğŸ“¥ Cloning AUR repository..."
          git clone ssh://aur@aur.archlinux.org/lyvoxa-bin.git aur-repo || {
            echo "âŒ Failed to clone AUR repo. Make sure:"
            echo "  1. SSH key is added to AUR account"
            echo "  2. Package 'lyvoxa-bin' exists (or create it first manually)"
            exit 1
          }
          
          echo "âœ… AUR repo cloned"

      - name: Update AUR repository
        run: |
          echo "ğŸ”„ Syncing files to AUR repo..."
          
          # Copy files
          cp lyvoxa-bin/PKGBUILD aur-repo/
          cp lyvoxa-bin/.SRCINFO aur-repo/
          
          # Optional: copy additional files
          [[ -f lyvoxa-bin/.gitignore ]] && cp lyvoxa-bin/.gitignore aur-repo/
          
          cd aur-repo
          
          # Configure Git
          git config user.name "Rezky Cahya Sahputra"
          git config user.email "with.rezky@gmail.com"
          
          # Check for changes
          if git diff --quiet && git diff --cached --quiet; then
            if [ "${{ github.event.inputs.force_push }}" != "true" ]; then
              echo "â„¹ï¸ No changes detected in PKGBUILD or .SRCINFO"
              echo "changed=false" >> $GITHUB_ENV
              exit 0
            else
              echo "âš ï¸ Force push requested"
            fi
          fi
          
          echo "âœ… Changes detected"
          echo "changed=true" >> $GITHUB_ENV
          
          # Show diff
          echo ""
          echo "ğŸ“ Changes to be pushed:"
          git diff HEAD

      - name: Commit and push to AUR
        if: env.changed == 'true'
        run: |
          cd aur-repo
          
          git add PKGBUILD .SRCINFO
          
          # Get version from PKGBUILD
          source PKGBUILD
          VERSION="${pkgver}-${pkgrel}"
          
          # Commit with descriptive message
          git commit -m "chore(aur): update to version $VERSION" \
                     -m "" \
                     -m "Automated sync from GitHub repository" \
                     -m "Source: https://github.com/oxyzenQ/lyvoxa" \
                     -m "" \
                     -m "Changes:" \
                     -m "- Updated PKGBUILD" \
                     -m "- Regenerated .SRCINFO" \
                     -m "" \
                     -m "Signed-off-by: Rezky Cahya Sahputra <with.rezky@gmail.com>"
          
          echo "ğŸš€ Pushing to AUR..."
          git push origin master
          
          echo ""
          echo "âœ… Successfully pushed to AUR"
          echo "ğŸ”— https://aur.archlinux.org/packages/lyvoxa-bin"

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ AUR SYNC SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          cd lyvoxa-bin
          source PKGBUILD
          
          if [ "${{ env.changed }}" == "true" ]; then
            echo "âœ… Package updated successfully"
            echo "ğŸ“‹ Package: $pkgname"
            echo "ğŸ”¢ Version: $pkgver-$pkgrel"
            echo "ğŸ”— AUR URL: https://aur.archlinux.org/packages/lyvoxa-bin"
            echo ""
            echo "ğŸ¯ Users can install with:"
            echo "   yay -S lyvoxa-bin"
            echo "   paru -S lyvoxa-bin"
          else
            echo "â„¹ï¸ No changes to push"
            echo "ğŸ“¦ Package: $pkgname $pkgver-$pkgrel"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
