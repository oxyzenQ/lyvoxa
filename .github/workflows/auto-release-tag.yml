name: üè∑Ô∏è Auto Tag Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  actions: read

jobs:
  auto-tag:
    name: üè∑Ô∏è Create release tag from commit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Detect release commit
        id: rel
        run: |
          set -euo pipefail
          MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $MSG"

          if [[ "$MSG" =~ ^chore\(release\):\ bump\ to\ ([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            TAG="$VERSION"
            echo "release=true" >> "$GITHUB_OUTPUT"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Release commit detected: $VERSION"
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è Not a release commit; skipping tag creation"
          fi

      - name: Create and push tag
        if: steps.rel.outputs.release == 'true'
        run: |
          set -euo pipefail
          TAG="${{ steps.rel.outputs.tag }}"

          git fetch --tags --force

          if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "‚ÑπÔ∏è Tag already exists: $TAG (skip)"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
