# =============================================================================
# LYVOXA RELEASE PIPELINE - PROFESSIONAL ORDERED BUILD
# =============================================================================
# Runs AFTER Version Bump Bot completes
# Order: Version Bump ‚Üí CI Pipeline ‚Üí Release Build ‚Üí AUR Sync
# Author: rezky_nightky

name: üåü Release

on:
  workflow_run:
    workflows: ["ü§ñ Version Bump Bot"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 3.0, 3.0.1)"
        required: true

permissions:
  contents: write
  security-events: write
  actions: read

env:
  CARGO_TERM_COLOR: always
  PROJECT_NAME: lyvoxa

jobs:
  # =============================================================================
  # STEP 1: RUN CI PIPELINE (CodeQL ‚Üí DCO ‚Üí Build/Test ‚Üí Performance)
  # =============================================================================
  run-ci:
    name: 1Ô∏è‚É£ Run CI Pipeline
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read
      checks: write
      security-events: write

  # =============================================================================
  # STEP 2: BUILD OPTIMIZED RELEASE
  # =============================================================================
  build-release:
    name: 2Ô∏è‚É£ Build Optimized Release
    runs-on: ubuntu-latest
    needs: run-ci
    # Only run if CI succeeded (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build Optimized Binary
        run: |
          echo "üöÄ Building optimized release with LTO..."
          export RUSTFLAGS="-C opt-level=z -C lto=fat -C codegen-units=1 -C strip=symbols"
          cargo build --release --target x86_64-unknown-linux-gnu
          strip --strip-all target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME

          echo ""
          echo "üìä Binary Analysis:"
          ls -lh target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME
          file target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME
          echo ""
          echo "‚úÖ Optimized release build completed"

      - name: Setup GPG (if available)
        run: |
          echo "üîê Setting up GPG for signing..."
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG
          echo "‚úÖ GPG key imported"
        continue-on-error: true

      - name: Create Package
        run: |
          # Get version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          VERSION=$(echo "$VERSION" | sed 's/^v//')
          ARTIFACT="$PROJECT_NAME-$VERSION-linux-amd64"

          # Create clean package structure
          mkdir -p $ARTIFACT/bin
          cp target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME $ARTIFACT/bin/
          cp README.md LICENSE $ARTIFACT/
          cp docs/CHANGELOG.md $ARTIFACT/ 2>/dev/null || true

          # Create tarball
          tar -czf $ARTIFACT.tar.gz $ARTIFACT/

          # Generate SHA256 checksum
          sha256sum $ARTIFACT.tar.gz > $ARTIFACT.tar.gz.sha256

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ARTIFACT=$ARTIFACT" >> $GITHUB_ENV

          echo "‚úÖ Package: $ARTIFACT.tar.gz ($(du -h $ARTIFACT.tar.gz | cut -f1))"

      - name: Sign Package (GPG - Full Verification Chain)
        run: |
          echo "üîè Creating professional signature chain..."
          echo ""

          # Function to sign with or without passphrase
          sign_file() {
            local input="$1"
            local output="$2"
            local armor="$3"

            if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
              echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 \
                --pinentry-mode loopback $armor --output "$output" --detach-sign "$input"
            else
              gpg --batch --yes $armor --output "$output" --detach-sign "$input"
            fi
          }

          # 1. Binary signature (.sig) - for packaging systems
          echo "üì¶ Creating binary signature (.sig)..."
          sign_file "$ARTIFACT.tar.gz" "$ARTIFACT.tar.gz.sig" ""

          # 2. ASCII-armored signature (.asc) - for humans & GitHub
          echo "üìú Creating ASCII-armored signature (.asc)..."
          sign_file "$ARTIFACT.tar.gz" "$ARTIFACT.tar.gz.asc" "--armor"

          # 3. Sign SHA256 checksum (full chain of trust)
          echo "üîê Signing SHA256 checksum..."
          sign_file "$ARTIFACT.tar.gz.sha256" "$ARTIFACT.tar.gz.sha256.asc" "--armor"

          echo ""
          echo "‚úÖ Signature Suite Created:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          ls -lh $ARTIFACT.tar.gz* | awk '{print "  " $9 " (" $5 ")"}'
          echo ""

          # Verify all signatures
          echo "üîç Verifying signatures..."
          echo ""

          if gpg --verify $ARTIFACT.tar.gz.sig $ARTIFACT.tar.gz 2>&1 | grep "Good signature"; then
            echo "‚úÖ Binary signature (.sig) valid"
          fi

          if gpg --verify $ARTIFACT.tar.gz.asc $ARTIFACT.tar.gz 2>&1 | grep "Good signature"; then
            echo "‚úÖ ASCII signature (.asc) valid"
          fi

          if gpg --verify $ARTIFACT.tar.gz.sha256.asc $ARTIFACT.tar.gz.sha256 2>&1 | grep "Good signature"; then
            echo "‚úÖ SHA256 signature (.sha256.asc) valid"
          fi

          echo ""
          echo "üéØ Professional Release Suite Complete:"
          echo "  üì¶ $ARTIFACT.tar.gz (binary)"
          echo "  üîê $ARTIFACT.tar.gz.sha256 (integrity)"
          echo "  ü§ñ $ARTIFACT.tar.gz.sig (machine signature)"
          echo "  üìú $ARTIFACT.tar.gz.asc (human signature)"
          echo "  ‚úÖ $ARTIFACT.tar.gz.sha256.asc (signed hash)"
        continue-on-error: true

      - name: Generate Changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "## Changes" > CHANGELOG.txt
            git log --oneline --pretty="- %s (%h)" -20 >> CHANGELOG.txt
          else
            echo "## Changes since $PREV_TAG" > CHANGELOG.txt
            git log $PREV_TAG..HEAD --oneline --pretty="- %s (%h)" >> CHANGELOG.txt
          fi

      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << EOF
          # Lyvoxa $VERSION

          **Linux x86_64 system monitoring tool**

          ## Installation

          \`\`\`bash
          wget https://github.com/oxyzenQ/lyvoxa/releases/download/$VERSION/$ARTIFACT.tar.gz
          wget https://github.com/oxyzenQ/lyvoxa/releases/download/$VERSION/$ARTIFACT.tar.gz.sha256
          sha256sum -c $ARTIFACT.tar.gz.sha256
          tar -xzf $ARTIFACT.tar.gz
          sudo cp $ARTIFACT/bin/* /usr/local/bin/
          \`\`\`

          ## What's Changed

          EOF
          cat CHANGELOG.txt >> RELEASE_NOTES.md

          cat >> RELEASE_NOTES.md << EOF

          ## üîê Verification (Professional Security Suite)

          This release includes a complete verification chain following industry standards (Debian/Arch/Blender style).

          ### Quick Verification (SHA256)
          \`\`\`bash
          sha256sum -c $ARTIFACT.tar.gz.sha256
          \`\`\`

          ### Full Verification (GPG + SHA256)

          **1. Import GPG public key (one-time setup):**
          \`\`\`bash
          gpg --keyserver hkps://keys.openpgp.org --recv-keys 0D8D13BB989AF9F0
          \`\`\`

          **2. Verify binary signature (machine-readable):**
          \`\`\`bash
          gpg --verify $ARTIFACT.tar.gz.sig $ARTIFACT.tar.gz
          \`\`\`

          **3. Verify ASCII signature (human-readable):**
          \`\`\`bash
          gpg --verify $ARTIFACT.tar.gz.asc $ARTIFACT.tar.gz
          \`\`\`

          **4. Verify signed checksum (full chain of trust):**
          \`\`\`bash
          gpg --verify $ARTIFACT.tar.gz.sha256.asc $ARTIFACT.tar.gz.sha256
          sha256sum -c $ARTIFACT.tar.gz.sha256
          \`\`\`

          ### üì¶ Available Files
          - \`$ARTIFACT.tar.gz\` - Binary package
          - \`$ARTIFACT.tar.gz.sha256\` - Integrity hash
          - \`$ARTIFACT.tar.gz.sig\` - Binary signature (packaging systems)
          - \`$ARTIFACT.tar.gz.asc\` - ASCII signature (humans/GitHub)
          - \`$ARTIFACT.tar.gz.sha256.asc\` - Signed checksum (full chain)

          **Expected GPG output:**
          \`\`\`
          gpg: Good signature from "Rezky Cahya Sahputra (Investor) <with.rezky@gmail.com>"
          \`\`\`

          **Full Changelog**: https://github.com/oxyzenQ/lyvoxa/commits/$VERSION
          EOF

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lyvoxa-release-artifacts-${{ github.sha }}
          path: |
            ${{ env.ARTIFACT }}.tar.gz
            ${{ env.ARTIFACT }}.tar.gz.sha256
            ${{ env.ARTIFACT }}.tar.gz.sig
            ${{ env.ARTIFACT }}.tar.gz.asc
            ${{ env.ARTIFACT }}.tar.gz.sha256.asc
            RELEASE_NOTES.md
          retention-days: 30

  # =============================================================================
  # STEP 3: PUBLISH RELEASE
  # =============================================================================
  publish:
    name: 3Ô∏è‚É£ Publish Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write

    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v5
        with:
          name: lyvoxa-release-artifacts-${{ github.sha }}
          path: ./release/

      - name: Prepare release files
        run: |
          cd release
          echo "üìã Files to publish:"
          ls -lh

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          name: "Lyvoxa ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: release/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "‚úÖ Release ${{ github.ref_name }} published successfully"
          echo "üì¶ Artifacts uploaded to GitHub Releases"
          echo "üîó https://github.com/oxyzenQ/lyvoxa/releases/tag/${{ github.ref_name }}"

