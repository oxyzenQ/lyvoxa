# =============================================================================
# LYVOXA RELEASE PIPELINE - PROFESSIONAL ORDERED BUILD
# =============================================================================
# Strict ordering: CodeQL â†’ Security â†’ Debug Build â†’ Performance â†’ Release â†’ Publish
# Author: rezky_nightky
# Version: Stellar 3.0

name: ðŸŒŸ Release

on:
  push:
    tags:
      - '*.*'           # Match: 3.0, 10.5, etc
      - '*.*.*'         # Match: 3.0.1, 10.5.2, etc
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 3.0, 3.0.1)"
        required: true

permissions:
  contents: write
  security-events: write
  actions: read

env:
  CARGO_TERM_COLOR: always
  PROJECT_NAME: lyvoxa

jobs:
  # =============================================================================
  # STEP 1: CODEQL SECURITY ANALYSIS
  # =============================================================================
  codeql:
    name: 1ï¸âƒ£ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v5
      - uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - uses: github/codeql-action/analyze@v3

  # =============================================================================
  # STEP 2: SECURITY & QUALITY CHECKS
  # =============================================================================
  security:
    name: 2ï¸âƒ£ Security & Quality
    runs-on: ubuntu-latest
    needs: codeql
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Run formatting check
        run: cargo fmt --check
      
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Audit dependencies
        run: |
          cargo install cargo-audit
          cargo audit || echo "Audit completed with warnings"

  # =============================================================================
  # STEP 3: BUILD DEBUG & TEST
  # =============================================================================
  build-debug:
    name: 3ï¸âƒ£ Build Debug & Test
    runs-on: ubuntu-latest
    needs: security
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu
      
      - name: Build Debug
        run: cargo build --target x86_64-unknown-linux-gnu
      
      - name: Run Tests
        run: cargo test --target x86_64-unknown-linux-gnu
      
      - name: Upload debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: lyvoxa-debug-${{ github.sha }}
          path: target/x86_64-unknown-linux-gnu/debug/lyvoxa
          retention-days: 7

  # =============================================================================
  # STEP 4: PERFORMANCE MONITORING
  # =============================================================================
  performance:
    name: 4ï¸âƒ£ Performance Monitoring
    runs-on: ubuntu-latest
    needs: build-debug
    steps:
      - uses: actions/checkout@v5
      
      - name: Download debug artifacts
        uses: actions/download-artifact@v5
        with:
          name: lyvoxa-debug-${{ github.sha }}
          path: ./artifacts/
      
      - name: Validate debug binary
        run: |
          chmod +x artifacts/lyvoxa
          echo "ðŸ§ª Validating debug binary..."
          if readelf -h artifacts/lyvoxa > /dev/null 2>&1; then
            echo "âœ… Debug binary is valid"
          else
            echo "âŒ Invalid binary"
            exit 1
          fi

  # =============================================================================
  # STEP 5: BUILD OPTIMIZED RELEASE
  # =============================================================================
  build-release:
    name: 5ï¸âƒ£ Build Optimized Release
    runs-on: ubuntu-latest
    needs: performance
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build Optimized Binary
        run: |
          echo "ðŸš€ Building optimized release with LTO..."
          export RUSTFLAGS="-C opt-level=z -C lto=fat -C codegen-units=1 -C strip=symbols"
          cargo build --release --target x86_64-unknown-linux-gnu
          strip --strip-all target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME
          
          echo ""
          echo "ðŸ“Š Binary Analysis:"
          ls -lh target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME
          file target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME
          echo ""
          echo "âœ… Optimized release build completed"

      - name: Setup GPG (if available)
        run: |
          echo "ðŸ” Setting up GPG for signing..."
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG
          echo "âœ… GPG key imported"
        continue-on-error: true

      - name: Create Package
        run: |
          # Get version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          VERSION=$(echo "$VERSION" | sed 's/^v//')
          ARTIFACT="$PROJECT_NAME-$VERSION-linux-amd64"
          
          # Create clean package structure
          mkdir -p $ARTIFACT/bin
          cp target/x86_64-unknown-linux-gnu/release/$PROJECT_NAME $ARTIFACT/bin/
          cp README.md LICENSE $ARTIFACT/
          cp docs/CHANGELOG.md $ARTIFACT/ 2>/dev/null || true
          
          # Create tarball
          tar -czf $ARTIFACT.tar.gz $ARTIFACT/
          
          # Generate SHA256 checksum
          sha256sum $ARTIFACT.tar.gz > $ARTIFACT.tar.gz.sha256
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ARTIFACT=$ARTIFACT" >> $GITHUB_ENV
          
          echo "âœ… Package: $ARTIFACT.tar.gz ($(du -h $ARTIFACT.tar.gz | cut -f1))"

      - name: Sign Package (GPG - Full Verification Chain)
        run: |
          echo "ðŸ” Creating professional signature chain..."
          echo ""
          
          # Function to sign with or without passphrase
          sign_file() {
            local input="$1"
            local output="$2"
            local armor="$3"
            
            if [ -n "${{ secrets.GPG_PASSPHRASE }}" ]; then
              echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 \
                --pinentry-mode loopback $armor --output "$output" --detach-sign "$input"
            else
              gpg --batch --yes $armor --output "$output" --detach-sign "$input"
            fi
          }
          
          # 1. Binary signature (.sig) - for packaging systems
          echo "ðŸ“¦ Creating binary signature (.sig)..."
          sign_file "$ARTIFACT.tar.gz" "$ARTIFACT.tar.gz.sig" ""
          
          # 2. ASCII-armored signature (.asc) - for humans & GitHub
          echo "ðŸ“œ Creating ASCII-armored signature (.asc)..."
          sign_file "$ARTIFACT.tar.gz" "$ARTIFACT.tar.gz.asc" "--armor"
          
          # 3. Sign SHA256 checksum (full chain of trust)
          echo "ðŸ” Signing SHA256 checksum..."
          sign_file "$ARTIFACT.tar.gz.sha256" "$ARTIFACT.tar.gz.sha256.asc" "--armor"
          
          echo ""
          echo "âœ… Signature Suite Created:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -lh $ARTIFACT.tar.gz* | awk '{print "  " $9 " (" $5 ")"}'
          echo ""
          
          # Verify all signatures
          echo "ðŸ” Verifying signatures..."
          echo ""
          
          if gpg --verify $ARTIFACT.tar.gz.sig $ARTIFACT.tar.gz 2>&1 | grep "Good signature"; then
            echo "âœ… Binary signature (.sig) valid"
          fi
          
          if gpg --verify $ARTIFACT.tar.gz.asc $ARTIFACT.tar.gz 2>&1 | grep "Good signature"; then
            echo "âœ… ASCII signature (.asc) valid"
          fi
          
          if gpg --verify $ARTIFACT.tar.gz.sha256.asc $ARTIFACT.tar.gz.sha256 2>&1 | grep "Good signature"; then
            echo "âœ… SHA256 signature (.sha256.asc) valid"
          fi
          
          echo ""
          echo "ðŸŽ¯ Professional Release Suite Complete:"
          echo "  ðŸ“¦ $ARTIFACT.tar.gz (binary)"
          echo "  ðŸ” $ARTIFACT.tar.gz.sha256 (integrity)"
          echo "  ðŸ¤– $ARTIFACT.tar.gz.sig (machine signature)"
          echo "  ðŸ“œ $ARTIFACT.tar.gz.asc (human signature)"
          echo "  âœ… $ARTIFACT.tar.gz.sha256.asc (signed hash)"
        continue-on-error: true

      - name: Generate Changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "## Changes" > CHANGELOG.txt
            git log --oneline --pretty="- %s (%h)" -20 >> CHANGELOG.txt
          else
            echo "## Changes since $PREV_TAG" > CHANGELOG.txt
            git log $PREV_TAG..HEAD --oneline --pretty="- %s (%h)" >> CHANGELOG.txt
          fi

      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << EOF
          # Lyvoxa $VERSION

          **Linux x86_64 system monitoring tool**

          ## Installation

          \`\`\`bash
          wget https://github.com/oxyzenQ/lyvoxa/releases/download/$VERSION/$ARTIFACT.tar.gz
          wget https://github.com/oxyzenQ/lyvoxa/releases/download/$VERSION/$ARTIFACT.tar.gz.sha256
          sha256sum -c $ARTIFACT.tar.gz.sha256
          tar -xzf $ARTIFACT.tar.gz
          sudo cp $ARTIFACT/bin/* /usr/local/bin/
          \`\`\`

          ## What's Changed

          EOF
          cat CHANGELOG.txt >> RELEASE_NOTES.md
          
          cat >> RELEASE_NOTES.md << EOF

          ## ðŸ” Verification (Professional Security Suite)

          This release includes a complete verification chain following industry standards (Debian/Arch/Blender style).

          ### Quick Verification (SHA256)
          \`\`\`bash
          sha256sum -c $ARTIFACT.tar.gz.sha256
          \`\`\`

          ### Full Verification (GPG + SHA256)
          
          **1. Import GPG public key (one-time setup):**
          \`\`\`bash
          gpg --keyserver hkps://keys.openpgp.org --recv-keys 0D8D13BB989AF9F0
          \`\`\`

          **2. Verify binary signature (machine-readable):**
          \`\`\`bash
          gpg --verify $ARTIFACT.tar.gz.sig $ARTIFACT.tar.gz
          \`\`\`

          **3. Verify ASCII signature (human-readable):**
          \`\`\`bash
          gpg --verify $ARTIFACT.tar.gz.asc $ARTIFACT.tar.gz
          \`\`\`

          **4. Verify signed checksum (full chain of trust):**
          \`\`\`bash
          gpg --verify $ARTIFACT.tar.gz.sha256.asc $ARTIFACT.tar.gz.sha256
          sha256sum -c $ARTIFACT.tar.gz.sha256
          \`\`\`

          ### ðŸ“¦ Available Files
          - \`$ARTIFACT.tar.gz\` - Binary package
          - \`$ARTIFACT.tar.gz.sha256\` - Integrity hash
          - \`$ARTIFACT.tar.gz.sig\` - Binary signature (packaging systems)
          - \`$ARTIFACT.tar.gz.asc\` - ASCII signature (humans/GitHub)
          - \`$ARTIFACT.tar.gz.sha256.asc\` - Signed checksum (full chain)

          **Expected GPG output:**
          \`\`\`
          gpg: Good signature from "Rezky Cahya Sahputra (Investor) <with.rezky@gmail.com>"
          \`\`\`

          **Full Changelog**: https://github.com/oxyzenQ/lyvoxa/commits/$VERSION
          EOF

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lyvoxa-release-artifacts-${{ github.sha }}
          path: |
            ${{ env.ARTIFACT }}.tar.gz
            ${{ env.ARTIFACT }}.tar.gz.sha256
            ${{ env.ARTIFACT }}.tar.gz.sig
            ${{ env.ARTIFACT }}.tar.gz.asc
            ${{ env.ARTIFACT }}.tar.gz.sha256.asc
            RELEASE_NOTES.md
          retention-days: 30

  # =============================================================================
  # STEP 6: PUBLISH RELEASE
  # =============================================================================
  publish:
    name: 6ï¸âƒ£ Publish Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write
    
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v5
        with:
          name: lyvoxa-release-artifacts-${{ github.sha }}
          path: ./release/
      
      - name: Prepare release files
        run: |
          cd release
          echo "ðŸ“‹ Files to publish:"
          ls -lh
          
      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          name: "Lyvoxa ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: release/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release ${{ github.ref_name }} published successfully"
          echo "ðŸ“¦ Artifacts uploaded to GitHub Releases"
          echo "ðŸ”— https://github.com/oxyzenQ/lyvoxa/releases/tag/${{ github.ref_name }}"

  # =============================================================================
  # STEP 7: UPDATE README WITH NEW VERSION
  # =============================================================================
  update-readme:
    name: 7ï¸âƒ£ Update README Version
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update version in README
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix if exists
          
          echo "ðŸ“ Updating README.md with version $VERSION_NUM"
          
          # Update version tag line
          sed -i "s/\*Version [0-9.]\+ Stellar\*/\*Version $VERSION_NUM Stellar\*/" README.md
          
          # Update download URLs
          sed -i "s|releases/download/[0-9.]\+/|releases/download/$VERSION_NUM/|g" README.md
          sed -i "s|lyvoxa-[0-9.]\+-linux-amd64|lyvoxa-$VERSION_NUM-linux-amd64|g" README.md
          
          echo "âœ… Version updated to $VERSION_NUM"
          
      - name: Check if README changed
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes needed in README"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… README has changes"
            git diff README.md
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs(readme): update version to ${{ github.ref_name }}

Auto-updated by release workflow after publishing release.

Changes:
- Version tag: ${{ github.ref_name }}
- Download URLs updated
- Installation commands synced

[skip ci]"
          git push origin main
          
          echo "âœ… README.md updated and pushed to main"
